<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Preview</title>
    <!-- Load page specific CSS which imports the layout -->
    <link rel="stylesheet" href="/Library/No_Overflow/Volumes/<%= volume %>/<%= chapter %>/<%= pageId %>/page.css">
    <style>
        body { margin: 0; padding: 0; background: #eee; height: 100vh; width: 100vw; overflow: hidden; }
        
        /* Force container visibility and fit */
        .section-container { 
            transform-origin: center top; 
            /* transform set via JS */
            margin: 20px auto; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); 
            opacity: 1 !important; /* Override base layout hidden state */
            background: #fff;
        }

        .panel { 
            border: 2px dashed #ccc; 
            transition: all 0.2s; 
            position: relative; 
            cursor: pointer;
            background: #f9f9f9;
        }
        
        .panel:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .panel.drag-over { 
            border: 4px solid #007bff; 
            background: rgba(0, 123, 255, 0.2); 
            z-index: 10; 
        }
        
        /* Overlay to show panel name */
        .panel-label {
            position: absolute; top: 0; left: 0; right:0; bottom:0;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.5); 
            color: #666;
            font-weight: bold; 
            pointer-events: none;
            transition: all 0.2s;
            font-size: 1.2rem;
            text-transform: uppercase;
            border: 1px solid transparent;
            text-align: center;
            flex-direction: column;
        }
        
        .panel-label span {
            font-size: 0.8rem;
            font-weight: normal;
            opacity: 0.7;
            margin-top: 5px;
        }

        /* If panel has content (img/video), hide label until hover */
        .panel:has(img), .panel:has(video) {
            border-style: solid;
            background: black;
        }

        .panel:has(img) .panel-label, 
        .panel:has(video) .panel-label {
            opacity: 0;
            background: rgba(0,0,0,0.6);
            color: white;
        }

        .panel:hover .panel-label { 
            opacity: 1; 
        }
    </style>
</head>
<body>
    <!-- Hidden Input for Click-to-Upload -->
    <input type="file" id="globalPanelUpload" style="display:none" accept="image/*,video/*">

    <%- content %>

    <script>
        const volume = "<%= volume %>";
        const chapter = "<%= chapter %>";
        const pageId = "<%= pageId %>";

        // Global State for Click Uploads
        const fileInput = document.getElementById('globalPanelUpload');
        let activeUploadTarget = null; // { panel, panelClass, label }

        // --- 1. Resizer ---
        function fitContainer() {
            const container = document.querySelector('.section-container');
            if (!container) return;
            
            container.style.transform = 'none';
            const padding = 40;
            const availableWidth = window.innerWidth - padding;
            const availableHeight = window.innerHeight - padding;
            const rect = container.getBoundingClientRect();
            const scaleX = availableWidth / rect.width;
            const scaleY = availableHeight / rect.height;
            const scale = Math.min(scaleX, scaleY, 1);
            container.style.transform = `scale(${scale})`;
        }
        window.addEventListener('resize', fitContainer);
        window.addEventListener('DOMContentLoaded', () => setTimeout(fitContainer, 100));

        // --- 2. Shared Upload Logic ---
        async function handleUpload(file, panelElement, panelClass, labelElement) {
            if (!file || !panelClass) return;

            // UI Feedback
            const originalText = labelElement.innerHTML;
            labelElement.innerHTML = "Uploading...";
            labelElement.style.color = "white";
            labelElement.style.background = "rgba(0,0,0,0.7)";

            const formData = new FormData();
            formData.append('volume', volume);
            formData.append('chapter', chapter);
            formData.append('pageId', pageId);
            formData.append('panel', '.' + panelClass);
            formData.append('asset', file);

            try {
                const res = await fetch('/api/editor/upload-asset', { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data.ok) {
                    labelElement.innerText = "Success!";
                    
                    // Render Preview
                    const isVideo = file.type.startsWith('video');
                    const el = isVideo ? document.createElement('video') : document.createElement('img');
                    
                    // We need the path. The API returns it, or we construct it.
                    // For immediate feedback, we can try to guess the path or use the file object (URL.createObjectURL)
                    // But to ensure it really worked, let's use the standard API path.
                    if (isVideo) {
                         el.src = `/api/videos/No_Overflow/${volume}/${chapter}/${pageId}/assets/${file.name}`;
                         el.controls = true;
                         el.muted = true;
                    } else {
                         el.src = `/api/images/No_Overflow/${volume}/${chapter}/${pageId}/assets/${file.name}`;
                    }
                    
                    el.style.width = '100%'; 
                    el.style.height = '100%'; 
                    el.style.objectFit = 'cover';

                    // Clear old content but KEEP the label
                    // We remove everything that isn't the label
                    Array.from(panelElement.children).forEach(child => {
                        if (child !== labelElement) panelElement.removeChild(child);
                    });
                    
                    panelElement.prepend(el); // Add new media behind label
                    
                    setTimeout(() => labelElement.innerHTML = panelClass, 1500);
                } else {
                    labelElement.innerHTML = "Error!";
                    alert(data.message);
                    setTimeout(() => labelElement.innerHTML = originalText, 2000);
                }
            } catch (err) {
                console.error(err);
                labelElement.innerHTML = "Failed";
                alert("Upload failed.");
                setTimeout(() => labelElement.innerHTML = originalText, 2000);
            }
        }

        // --- 3. Click-to-Upload Handler ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && activeUploadTarget) {
                handleUpload(file, activeUploadTarget.panel, activeUploadTarget.panelClass, activeUploadTarget.label);
            }
            // Reset input so we can select the same file again if needed
            fileInput.value = ''; 
            activeUploadTarget = null;
        });

        // --- 4. Loader ---
        async function loadExistingMedia() {
            try {
                const res = await fetch(`/api/media/${volume}/${chapter}/${pageId}`);
                const data = await res.json();
                
                if (data.ok && data.media && Array.isArray(data.media.media)) {
                    data.media.media.forEach(item => {
                        const panel = document.querySelector(item.panel);
                        if (!panel) return;

                        let el;
                        if (item.type === 'image') {
                            el = document.createElement('img');
                            el.src = `/api/images/No_Overflow/${volume}/${chapter}/${pageId}/assets/${item.fileName}`;
                        } else if (item.type === 'video') {
                            el = document.createElement('video');
                            el.src = `/api/videos/No_Overflow/${volume}/${chapter}/${pageId}/assets/${item.fileName}`;
                            el.muted = true;
                            el.controls = true;
                        }

                        if (el) {
                            el.style.width = '100%';
                            el.style.height = '100%';
                            el.style.objectFit = 'cover';
                            
                            // Clear existing but keep label (if we added it already)
                            // But this runs on load, so labels might be added after.
                            // Let's just append for now, and the loop below will handle label z-index/placement
                            panel.innerHTML = '';
                            panel.appendChild(el);
                        }
                    });
                }
            } catch (e) { console.error("Failed to load media:", e); }

            // Initialize Panels
            initPanels(); 
        }

        function initPanels() {
            document.querySelectorAll('.panel').forEach(panel => {
                // Determine Class
                const classes = Array.from(panel.classList);
                const panelClass = classes.find(c => c.startsWith('panel-') && c !== 'panel');
                
                // Create Label
                const label = document.createElement('div');
                label.className = 'panel-label';
                label.innerHTML = `${panelClass || 'Unknown'}<br><span>Click or Drop to Upload</span>`;
                panel.appendChild(label);

                // --- Events ---
                
                // Drag
                panel.addEventListener('dragover', (e) => { e.preventDefault(); panel.classList.add('drag-over'); });
                panel.addEventListener('dragleave', (e) => { panel.classList.remove('drag-over'); });
                panel.addEventListener('drop', (e) => {
                    e.preventDefault();
                    panel.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file) handleUpload(file, panel, panelClass, label);
                });

                // Click
                panel.addEventListener('click', (e) => {
                    // Highlight
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('selected'));
                    panel.classList.add('selected');

                    // Notify Parent
                    window.parent.postMessage({ 
                        type: 'panelSelected', 
                        panel: '.' + panelClass, // Send selector
                        volume, chapter, pageId 
                    }, '*');
                }, true); // Use Capture to catch clicks even on video controls
            });
        }

        // Listen for messages from parent
        window.addEventListener('message', (e) => {
            if (e.data.type === 'triggerUpload') {
                const pClass = e.data.panel.replace('.', '');
                const p = document.querySelector(e.data.panel);
                if (p) {
                    const label = p.querySelector('.panel-label');
                    activeUploadTarget = { panel: p, panelClass: pClass, label: label };
                    fileInput.click();
                }
            }
        });

        loadExistingMedia();
    </script>
    <style>
        .panel.selected {
            border-color: #ff9800 !important;
            box-shadow: 0 0 10px #ff9800;
        }
    </style>
</body>
</html>